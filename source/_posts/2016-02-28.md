
---
date: 2016-02-28 18:30:58
categories: python
title: ä½¿ç”¨codecsè‡ªå®šä¹‰ç¼–/è§£ç æ–¹æ¡ˆ
tags: [python]
---
ç›¸ä¿¡å¾ˆå¤šä½¿ç”¨Pythonçš„åŒå­¦ç†Ÿæ‚‰ç¼–è§£ç ï¼Œæ¯”å¦‚ï¼š

``` python    
    
    In : print u'\U0001F3F4'.encode('utf-8')  
    ğŸ´  
    In : 'å“ˆå“ˆ'.decode('utf8')  
    Out: u'\u54c8\u54c8'  
      
```
  
è¿™æ ·å¯ä»¥åœ¨å­—ç¬¦ä¸²å’Œunicodeä¹‹å‰è½¬æ¢ï¼Œä¸è¿‡ç»†å¿ƒçš„åŒå­¦å¯èƒ½å‘ç°äº†ï¼Œæˆ‘ä½¿ç”¨äº†ã€Œutf-8ã€å’Œã€Œutf8ã€ï¼Œè¿™2ä¸ªè¯é•¿å¾—å¾ˆåƒã€‚äº‹å®ä¸Šéƒ½èƒ½æ­£å¸¸ä½¿ç”¨æ˜¯ç”±äºä»–ä»¬éƒ½æ˜¯ã€Œutf_8ã€çš„åˆ«åï¼Œè¿™äº›åˆ«åçš„å¯¹åº”å…³ç³»å¯ä»¥ç”¨å¦‚ä¸‹æ–¹æ³•æ‰¾åˆ°ï¼š

``` python    
    
    In : import encodings  
      
    In : encodings.aliases.aliases['utf8']  
    Out: 'utf_8'  
      
    In : 'å“ˆå“ˆ'.decode('u8')  
    Out: u'\u54c8\u54c8'  
      
    In : 'å“ˆå“ˆ'.decode('utf')  
    Out: u'\u54c8\u54c8'  
      
    In : 'å“ˆå“ˆ'.decode('utf8_ucs2')  
    Out: u'\u54c8\u54c8'  
      
    In : 'å“ˆå“ˆ'.decode('utf8_ucs4')  
    Out: u'\u54c8\u54c8'  
      
```
  
encodingsæ˜¯æ ‡å‡†åº“ä¸­è‡ªå¸¦çš„ç¼–ç åº“ï¼Œå…¶ä¸­åŒ…å«äº†ä¸Šç™¾ä¸ªæ ‡å‡†çš„ç¼–ç è½¬æ¢æ–¹æ¡ˆã€‚ä½†æ˜¯é€šå¸¸å¹¶ä¸éœ€è¦ä½¿ç”¨encodingsï¼Œè€Œæ˜¯ä½¿ç”¨codecsã€‚
codecsåŒ…å«äº†ç¼–ç è§£ç å™¨çš„æ³¨å†Œå’Œå…¶ä»–åŸºæœ¬çš„ç±»ï¼Œå¼€å‘è€…è¿˜å¯ä»¥é€šè¿‡codecsæä¾›çš„æ¥å£è‡ªå®šä¹‰ç¼–/è§£ç æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åˆ›é€ ä¸€ä¸ªæ–°çš„ç¼–è§£ç è½¬æ¢æ–¹æ¡ˆï¼Œä½¿ç”¨encode(â€˜XXâ€™)å’Œdecode(â€˜XXâ€™)çš„æ–¹å¼ä½¿ç”¨ã€‚ä»Šå¤©æˆ‘ç»™å¤§å®¶æ¼”ç¤ºç›´æ¥è¿›è¡ŒFernetå¯¹ç§°åŠ å¯†çš„ä¾‹å­ã€‚
äº’è”ç½‘å®‰å…¨çš„é‡è¦æ€§ä¸å¿…åœ¨å¤è¿°äº†ï¼Œå¤§å®¶éƒ½åº”è¯¥æ¥è§¦è¿‡ä¸€äº›åŠ å¯†æŠ€æœ¯ï¼Œå¯èƒ½å¬è¿‡M2Cryptoã€PyCryptoã€Cryptographyä¹‹ç±»çš„åº“ã€‚åœ¨è¿™é‡Œæ­ªä¸ªæ¥¼ï¼Œç°åœ¨çš„ä¸»æµæ˜¯ä½¿ç”¨Cryptographyï¼Œå®ƒçš„å‡ºç°å°±æ˜¯ä¸ºäº†æ›¿ä»£ä¹‹å‰çš„é‚£äº›åº“ï¼Œå…·ä½“çš„å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚æˆ‘ä»¬ä½¿ç”¨Cryptographyæä¾›çš„Fernetç±»æ¥å®ç°ï¼Œé¦–å…ˆå®ç°ä¸€ä¸ªCodecç±»ï¼š

``` python    
    
    import codecs  
      
    from cryptography.fernet import Fernet  
    from cryptography.fernet import InvalidToken  
      
    KEY = Fernet.generate_key()  
    f = Fernet(KEY)  
      
      
    class FernetCodec(codecs.Codec):  
        def encode(self, input, errors='fernet.strict'):  
            return f.encrypt(input), len(input)  
      
        def decode(self, input, errors='fernet.strict'):  
            try:  
                return f.decrypt(input), len(input)  
            except InvalidToken:  
                error = codecs.lookup_error(errors)  
                return error(UnicodeDecodeError('fernet', input, 0, len(input) + 1,  
                                                'Invalid Token'))  
      
```
  
å½“ç„¶ä¹Ÿä¸å¿…åœ¨ç±»ä¸­å®ç°encodeå’Œdecodeæ–¹æ³•ï¼Œå•ç‹¬çš„2ä¸ªå‡½æ•°ä¹Ÿå¯ä»¥ã€‚æˆ‘è¿™é‡Œæ˜¯ä¸ºäº†ç»™ä¹‹åçš„æ¼”ç¤ºåˆ°çš„ç±»å¤ç”¨ã€‚
å¦‚æœä½ çœ‹è¿‡å†…ç½®çš„å­—ç¬¦ä¸²encodeçš„æ–¹æ³•ï¼Œå®ƒçš„æ–‡æ¡£è¯´è¿˜æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•°ï¼Œè®©ä½ å‘Šè¯‰å®ƒå½“å‡ºç°å‡ºé”™çš„æ—¶å€™å¦‚ä½•å»å¤„ç†ï¼Œé»˜è®¤æ˜¯strictï¼Œç›´æ¥å°±ä¼šæŠ›å‡ºæ¥é”™è¯¯ã€‚  
å…¶ä½™å¯é€‰çš„è¿˜æœ‰ignoreã€replaceã€xmlcharrefreplaceï¼š

``` python    
    
    In [35]: '\x80abc'.decode('utf-8', 'strict')  
    ---------------------------------------------------------------------------  
    UnicodeDecodeError                        Traceback (most recent call last)  
    <ipython-input-35-974ebc908d50> in <module>()  
    ----> 1 '\x80abc'.decode('utf-8', 'strict')  
      
    /Users/dongweiming/dae/venv/lib/python2.7/encodings/utf_8.pyc in decode(input, errors)  
     
         15 def decode(input, errors='strict'):  
    ---> 16     return codecs.utf_8_decode(input, errors, True)  
     
         18 class IncrementalEncoder(codecs.IncrementalEncoder):  
      
    UnicodeDecodeError: 'utf8' codec can't decode byte 0x80 in position 0: invalid start byte  
      
    In [36]: '\x80abc'.decode('utf-8', 'replace')  
    Out[36]: u'\uffabc'  
      
    In [37]: '\x80abc'.decode('utf-8', 'ignore')  
    Out[37]: u'abc'  
      
```
  
äº‹å®ä¸ŠPythonè¿˜å†…ç½®äº†å…¶ä»–çš„é€‰é¡¹ï¼Œå¦‚backslashreplaceã€namereplaceã€surrogatepassã€surrogateescapeç­‰ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹[æºç å®ç°](https://github.com/python/cpython/blob/6f0eb93183519024cb360162bdd81b9faec97ba6/Python/codecs.c#L1422).
æˆ‘ä¹Ÿä¼šå®šä¹‰2ç§é”™è¯¯å‡½æ•°ï¼Œå› ä¸ºåœ¨è§£å¯†ï¼ˆæ‰§è¡Œdecryptï¼‰çš„æ—¶å€™å¯èƒ½ä¼šæŠ¥InvalidTokené”™è¯¯ï¼Œä½†æ˜¯InvalidTokenä¸åŒ…å«ä»»ä½•å‚æ•°ï¼Œè€Œå¯¹é”™è¯¯å¤„ç†çš„æ—¶å€™éœ€è¦çŸ¥é“èµ·å§‹å’Œç»“æŸçš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘å°±ç›´æ¥æŠ›ä¸€ä¸ªUnicodeDecodeErroré”™è¯¯äº†ã€‚
æ¥ç€æˆ‘ä»¬å®šä¹‰é€’å¢å¼å’Œæµå¼çš„ç¼–ç ç±»ï¼š

``` python    
    
    class IncrementalEncoder(codecs.IncrementalEncoder, FernetCodec):  
        pass  
      
      
    class IncrementalDecoder(codecs.IncrementalDecoder, FernetCodec):  
        pass  
      
      
    class StreamReader(FernetCodec, codecs.StreamReader):  
        pass  
      
      
    class StreamWriter(FernetCodec, codecs.StreamWriter):  
        pass  
      
```
  
ç”±äºè¿™ä¸ªè¦åŠ å¯†çš„å­—ç¬¦ä¸²ä¸ä¼šå¾ˆé•¿ï¼Œæ²¡æœ‰å¿…è¦å®ç°è¿™äº›ç±»ï¼Œæˆ‘å°±ç®€å•çš„ç»§æ‰¿ç„¶åpassäº†ã€‚æ¥ç€å¼€å¼€æ”¾å…¥å£ï¼š

``` python    
    
    def getregentry():  
        return codecs.CodecInfo(  
            name='fernet',  
            encode=FernetCodec().encode,  
            decode=FernetCodec().decode,  
            incrementalencoder=IncrementalEncoder,  
            incrementaldecoder=IncrementalDecoder,  
            streamwriter=StreamWriter,  
            streamreader=StreamReader,  
        )  
      
```
  
å…¶å®incrementalencoderã€streamwriterè¿™äº›å‚æ•°ä¸ä¼ é€’ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œé»˜è®¤æ˜¯Noneï¼Œä»Šå¤©åªæ˜¯ä¸ºäº†è®©å¤§å®¶çŸ¥é“æ˜¯æœ‰è¿™éƒ¨åˆ†æ¥å£çš„ã€‚ç„¶åæ˜¯æ³¨å†Œè¿™ä¸ªå…¥å£ï¼Œä¸ºäº†æä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œæˆ‘åˆ›å»ºä¸€ä¸ªå‡½æ•°åŠ ä¸Šç¼“å­˜åŠŸèƒ½ï¼š

``` python    
    
    _cache = {}  
    _unknown = '--unknown--'  
      
    def search_function(encoding):  
        import encodings  
        encoding = encodings.normalize_encoding(encoding)  
        entry = _cache.get(encoding, _unknown)  
        if entry is not _unknown:  
            return entry  
      
        if encoding == 'fernet':  
            entry = getregentry()  
            _cache[encoding] = entry  
            return entry  
                             
                             
    codecs.register(search_function)  
      
```
  
è¿™é‡Œç®€å•ä»‹ç»ä¸‹normalize_encodingçš„æ„ä¹‰ï¼Œä¹‹å‰æˆ‘è¯´åˆ°äº†åˆ«åï¼Œæˆ‘ä»¬å†æ„Ÿå—ä¸‹ï¼š

``` python    
    
    In : u'å“ˆå“ˆ'.encode('utf-8')  
    Out: '\xe5\x93\x88\xe5\x93\x88'  
      
    In : u'å“ˆå“ˆ'.encode('utf_8')  
    Out: '\xe5\x93\x88\xe5\x93\x88'  
      
```
  
è¿™ç§ä¸­åˆ’çº¿å’Œä¸‹åˆ’çº¿æœ€åæ— å·®åˆ«å¯¹å¾…ï¼Œå°±æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°æ ‡å‡†åŒ–çš„ã€‚
codecsæ¨¡å—åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªæœç´¢å‡½æ•°çš„åˆ—è¡¨ï¼Œé€šè¿‡è°ƒç”¨codecs.registeræ–¹æ³•å°±æŠŠä¸Šè¿°å‡½æ•°appendè¿›å»äº†ã€‚
æœ€åæˆ‘ä»¬æ³¨å†Œ2ä¸ªé”™è¯¯å¤„ç†çš„å‡½æ•°ï¼š

``` python    
    
    def strict_errors(exc):  
        if isinstance(exc, UnicodeDecodeError):  
            raise TypeError('Invalid Token')  
      
      
    def fallback_errors(exc):  
        s = []  
        for c in exc.object[exc.start:exc.end]:  # åªæ˜¯ä¸ºäº†æ¼”ç¤ºæä¾›çš„æ¥å£ï¼Œå®æ–½ä¸Šå°±æ˜¯è¿”å›åŸæ¥çš„input  
            s.append(c)  
        return ''.join(s), exc.end  
      
    codecs.register_error('fernet.strict', strict_errors)  
    codecs.register_error('fernet.fallback', fallback_errors)  
      
```
  
é»˜è®¤ä½¿ç”¨çš„æ˜¯fernet.strictè¿™ç§å¤„ç†æ–¹æ¡ˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨fallbackæ¨¡å¼ã€‚okï¼Œæˆ‘ä»¬ç°åœ¨æ„Ÿå—ä¸€ä¸‹ï¼š

``` python    
    
    In [1]: import fernet  
      
    In [2]: input = 'hah'  
      
    In [3]: output = input.encode('fernet')  
      
    In [4]: output  # å·²ç»æ˜¯åŠ å¯†åçš„ç»“æœäº†  
    Out[4]: 'gAAAAABZCFa6Znp2a_e9O0VqP6qToO6T3xRbF7O-adtpFC4QYO7jvVc6Yrcwbo6YGQfL8g5HCXcsaan_THWNhjZAorPTwlQQTA=='  
      
    In [5]: output.decode('fernet')  # è§£å¯†åè¿˜åŸæˆåŸæ¥çš„å­—ç¬¦ä¸²  
    Out[5]: 'hah'  
      
    In [6]: input.decode('fernet')  
    'fernet' codec can't decode bytes in position 0-3: Invalid Token  
    ---------------------------------------------------------------------------  
    TypeError                                 Traceback (most recent call last)  
    <ipython-input-6-1c20dc246c52> in <module>()  
    ----> 1 input.decode('fernet')  
      
    /Users/dongweiming/test/tmp/fernet.pyc in decode(self, input, errors)  
         20             error = codecs.lookup_error(errors)  
         21             return error(UnicodeDecodeError('fernet', input, 0, len(input) + 1,  
    ---> 22                                             'Invalid Token'))  
     
     
      
    /Users/dongweiming/test/tmp/fernet.pyc in strict_errors(exc)  
         68     print exc  
         69     if isinstance(exc, UnicodeDecodeError):  
    ---> 70         raise TypeError('Invalid Token')  
     
     
      
    TypeError: Invalid Token  # æŠ›äº†ä¸ªè‡ªå®šä¹‰é”™è¯¯  
      
    In [7]: input.decode('fernet', 'fernet.fallback')  
    Out[7]: 'hah'  # è§£å¯†ä¸æˆåŠŸï¼Œè¿”å›åŸæ¥çš„å­—ç¬¦ä¸²  
      
```
  
å¥½äº†ï¼Œè‡ªå®šä¹‰çš„åŠ è§£å¯†æ–¹æ¡ˆå®Œæˆäº†ï¼Œæ•´ç†å…¨éƒ¨çš„ä»£ç å¦‚ä¸‹ï¼š
    
    


    
``` python    
    
    import codecs  
      
    from cryptography.fernet import Fernet  
    from cryptography.fernet import InvalidToken  
      
    KEY = Fernet.generate_key()  
    f = Fernet(KEY)  
    _cache = {}  
    _unknown = '--unknown--'  
      
      
    class FernetCodec(codecs.Codec):  
        def encode(self, input, errors='fernet.strict'):  
            return f.encrypt(input), len(input)  
      
        def decode(self, input, errors='fernet.strict'):  
            try:  
                return f.decrypt(input), len(input)  
            except InvalidToken:  
                error = codecs.lookup_error(errors)  
                return error(UnicodeDecodeError('fernet', input, 0, len(input) + 1,  
                                                'Invalid Token'))  
      
      
    class IncrementalEncoder(codecs.IncrementalEncoder, FernetCodec):  
        pass  
      
      
    class IncrementalDecoder(codecs.IncrementalDecoder, FernetCodec):  
        pass  
      
      
    class StreamReader(FernetCodec, codecs.StreamReader):  
        pass  
      
      
    class StreamWriter(FernetCodec, codecs.StreamWriter):  
        pass  
      
      
      
    def getregentry():  
        return codecs.CodecInfo(  
            name='fernet',  
            encode=FernetCodec().encode,  
            decode=FernetCodec().decode,  
            incrementalencoder=IncrementalEncoder,  
            incrementaldecoder=IncrementalDecoder,  
            streamwriter=StreamWriter,  
            streamreader=StreamReader,  
        )  
      
      
    def search_function(encoding):  
        import encodings  
        encoding = encodings.normalize_encoding(encoding)  
        entry = _cache.get(encoding, _unknown)  
        if entry is not _unknown:  
            return entry  
      
        if encoding == 'fernet':  
            entry = getregentry()  
            _cache[encoding] = entry  
            return entry  
      
      
    def strict_errors(exc):  
        if isinstance(exc, UnicodeDecodeError):  
            raise TypeError('Invalid Token')  
      
      
    def fallback_errors(exc):  
        s = []  
        for c in exc.object[exc.start:exc.end]:  
            s.append(c)  
        return ''.join(s), exc.end  
      
      
    codecs.register(search_function)  
    codecs.register_error('fernet.strict', strict_errors)  
    codecs.register_error('fernet.fallback', fallback_errors)  
      
```

ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ç”± è‘£ä¼Ÿæ˜ åŸåˆ›ï¼Œæœªç»ä½œè€…æˆæƒç¦æ­¢ä»»ä½•å¾®ä¿¡å…¬ä¼—å·å’Œå‘æ˜é‡‘(juejin.im)è½¬è½½ï¼Œ[æŠ€æœ¯åšå®¢è½¬è½½é‡‡ç”¨ ä¿ç•™ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0-å›½é™…è®¸å¯åè®®](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh)
python
