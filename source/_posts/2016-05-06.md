
---
date: 2016-05-06 18:30:58
categories: python
title: ä½¿ç”¨pipenvç®¡ç†ä½ çš„é¡¹ç›®
tags: [python]
---
### å‰è¨€
åˆšæ‰ä½¿ç”¨pipenvå‘ç°äº†ä¸€ä¸ªbug,
é¡ºæ‰‹æäº†ä¸ªçš„PRã€‚æ— èŠä¹‹ä¸‹ç¿»äº†ä¸‹è´¡çŒ®è€…åˆ—è¡¨ï¼Œè²Œä¼¼æ²¡æœ‰ä¸€ä¸ªæˆ‘å›½çš„å¼€å‘è€…ï¼æˆ‘çš„æ™®åŠå·¥ä½œä»»é‡è€Œé“è¿œå•Šï¼Œæˆ‘å†™ç¯‡æ–‡ç« ç»™å¤§å®¶ä»‹ç»ä¸‹è¿™ä¸ªç»ˆæå¤§æ€å™¨ã€‚
Pythonå¼€å‘è€…åº”è¯¥å¬è¿‡pipã€easy_installå’Œvirtualenvï¼Œå¦‚æœçœ‹è¿‡æˆ‘çš„ä¹¦åº”è¯¥è¿˜çŸ¥é“
virtualenvwrapperã€virtualenv-burritoå’Œautoenvï¼Œå†åŠ ä¸Špyvenvã€venvï¼ˆPython
3æ ‡å‡†åº“ï¼‰ã€pyenvâ€¦
é¢ï¼Œæ˜¯ä¸æ˜¯æœ‰ç§å‘æ‡µçš„æ„Ÿè§‰ï¼Ÿ
é‚£ä¹ˆç°åœ¨æœ‰ä¸ªå¥½æ¶ˆæ¯ï¼Œä½ å¯ä»¥åªä½¿ç”¨ç»ˆææ–¹æ¡ˆ: pipenv + autoenvï¼ˆå¯é€‰ï¼‰ã€‚
ã€Œç»ˆææ–¹æ¡ˆã€ï¼Œå¬èµ·æ¥å¥½å™±å¤´å‘€ã€‚ç»™å‡ºæˆ‘çš„ç†ç”±ä¹‹å‰æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹Pythonè™šæ‹Ÿç¯å¢ƒå’ŒåŒ…ç®¡ç†çš„å†å²å§ã€‚
### å†å²
åœ¨Pythonå‘å±•å²ä¸Šå‡ºç°äº†å¾ˆå¤šåˆ›å»ºå’Œå‘å¸ƒåŒ…çš„å·¥å…·ã€‚
å½“ä½ æƒ³è¦æŠŠä½ çš„é¡¹ç›®åˆ†äº«å‡ºå»ï¼Œæ”¾åˆ°PYPIæˆ–è€…å…¶ä»–æ‰˜ç®¡æœåŠ¡ä¸Šçš„æ—¶å€™ï¼Œå°±éœ€è¦å€ŸåŠ©è¿™æ ·çš„å·¥å…·æ¥æ„å»ºå’Œåˆ†å‘é¡¹ç›®ã€‚æ—©åœ¨1998å¹´Pythonæ ‡å‡†åº“å†…ç½®äº†æ¨¡å—distutilsï¼Œä½†æ˜¯åªæä¾›äº†æœ‰é™çš„æ”¯æŒï¼Œä¹‹åç¤¾åŒºé€‰æ‹©é€šè¿‡setuptoolsè¿™ä¸ªåŒ…å®ç°æ„å»ºå’Œå‘å¸ƒï¼Œå®ƒè‡ªå¸¦easy_installï¼Œèƒ½å¸®åŠ©ä½ æ‰¾åˆ°ã€ä¸‹è½½ã€å®‰è£…ä»¥åŠæ›´æ–°éœ€è¦ä½¿ç”¨çš„åŒ…ã€‚ä¸è¿‡ä¾ç„¶åŠŸèƒ½å¾ˆæœ‰é™ï¼Œæ¯”å¦‚ä¸èƒ½åˆ é™¤åŒ…ã€‚
å½“ä½ åšä¸€ä¸ªä¸“èŒçš„Pythonå¼€å‘ï¼Œç‹¬ç«‹çš„è™šæ‹Ÿç¯å¢ƒä¹Ÿæ˜¯ä¸€ä¸ªå¼€å‘ä¸­è¿«åˆ‡éœ€è¦çš„åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œè¯·å¤§å®¶è®°ä½ä¸€ä¸ª Ian Bickingï¼ˆä¸‹ç§°ianbï¼‰
çš„å¼€å‘è€…ï¼Œ08å¹´ï¼Œä»–å¼€å‘äº†virtualenvã€‚
ç¤¾åŒºä¸€äº›Pythonæ ¸å¿ƒå¼€å‘è€…å’ŒçŸ¥åé¡¹ç›®ï¼ˆå¦‚Djangoï¼‰æ ¸å¿ƒå¼€å‘è€…ä¹Ÿåœ¨æ”¯æŒå’Œæ¨åŠ¨è¿™ä»¶äº‹ï¼Œåæ¥æˆç«‹äº†pypa(Python Packaging
Authority)ï¼Œpypaæ—©æœŸåšçš„å°±æ˜¯pip - ç°åœ¨æœ€ä¸»æµçš„å®‰è£…åŒ…çš„å·¥å…·ã€‚å†æä¸€ä¸‹ï¼Œianbä¹Ÿæ˜¯pipçš„æ—©æœŸæ ¸å¿ƒå¼€å‘è€…ã€‚
ä¸è¿‡éå¸¸é—æ†¾ï¼Œç”±äºå’Œç¤¾åŒºäº§ç”Ÿäº†ä¸€äº›çŸ›ç›¾ï¼Œianbå¾ˆæ—©ä¹‹å‰å°±ä¸å†å†™Pythoné¡¹ç›®ï¼ˆå¯è§è¿™çŸ›ç›¾å¤šå¤§å‘€
ğŸ˜®ï¼‰ï¼Œvirtualenvä¹Ÿè½¬ç»™äº†å…¶ä»–å¼€å‘è€…ï¼Œè¿™æ˜¯Pythonç¤¾åŒºä¸€ä¸ªæå¤§çš„æŸå¤±ã€‚
ç°åœ¨pipå’Œvirtualenvå·²ç»è¢«å¤§å®¶æ‰€ç†ŸçŸ¥ï¼Œç”šè‡³å¯ä»¥è¯´æ˜¯Pythonå®˜æ–¹çš„åŒ…ç®¡ç†å’Œè™šæ‹Ÿç¯å¢ƒé€‰æ‹©ã€‚ä¸è¿‡å…¶å®è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œæˆ‘ä¸¾å‡ ä¸ªä¾‹å­ï¼š
  1. å¿…é¡»æ‰‹åŠ¨å®‰è£…æˆ–åˆ é™¤æŸäº›ç‰¹å®šç‰ˆæœ¬çš„åŒ…ï¼Œå¹¶è®°å¾—å®šæœŸæ›´æ–°requirements.txtæ–‡ä»¶ï¼Œä»¥ä¿æŒé¡¹ç›®ç¯å¢ƒçš„ä¸€è‡´
  2. æœ‰æ—¶é¡¹ç›®ä¸­éœ€è¦æœ‰å¤šä¸ªrequirements.txtæ–‡ä»¶ï¼Œæ¯”å¦‚å¼€å‘æ—¶åº”è¯¥ç”¨dev-requirements.txtï¼Œç°æœ‰çš„æ¨¡å¼ä¸èƒ½æ»¡è¶³è¿™äº›å¤æ‚çš„éœ€è¦
  3. å¸è½½åŒ…çš„æ—¶å€™åªæ˜¯å¸è½½åŒ…è‡ªå·±ï¼Œä¸èƒ½å¤„ç†ç›¸å…³ä¾èµ–ï¼Œæ—¶é—´ä¹…äº†é¡¹ç›®ç¯å¢ƒå°±æ··ä¹±äº†
### pipenv æ˜¯ä»€ä¹ˆï¼Ÿ
Pipenv æ˜¯ Python é¡¹ç›®çš„ä¾èµ–ç®¡ç†å™¨ã€‚å…¶å®å®ƒä¸æ˜¯ä»€ä¹ˆå…ˆè¿›çš„ç†å¿µå’ŒæŠ€æœ¯ï¼Œå¦‚æœä½ ç†Ÿæ‚‰ Node.js çš„ npm/yarn æˆ– Ruby çš„
bundlerï¼Œé‚£ä¹ˆå°±éå¸¸å¥½ç†è§£äº†ï¼Œå®ƒåœ¨æ€è·¯ä¸Šä¸è¿™äº›å·¥å…·ç±»ä¼¼ã€‚å°½ç®¡pipå¯ä»¥å®‰è£…PythonåŒ…ï¼Œä½†ä»æ¨èä½¿ç”¨Pipenvï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§æ›´é«˜çº§çš„å·¥å…·ï¼Œå¯ç®€åŒ–ä¾èµ–å…³ç³»ç®¡ç†çš„å¸¸è§ä½¿ç”¨æƒ…å†µã€‚
ä¸»è¦ç‰¹æ€§åŒ…å«ï¼š
  1. æ ¹æ® Pipfile è‡ªåŠ¨å¯»æ‰¾é¡¹ç›®æ ¹ç›®å½•ã€‚
  2. å¦‚æœä¸å­˜åœ¨ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ Pipfile å’Œ Pipfile.lockã€‚
  3. è‡ªåŠ¨åœ¨é¡¹ç›®ç›®å½•çš„ .venv ç›®å½•åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚ï¼ˆå½“ç„¶è¿™ä¸ªç›®å½•åœ°å€é€šè¿‡è®¾ç½®WORKON_HOMEæ”¹å˜ï¼‰
  4. è‡ªåŠ¨ç®¡ç† Pipfile æ–°å®‰è£…å’Œåˆ é™¤çš„åŒ…ã€‚
  5. è‡ªåŠ¨æ›´æ–° pipã€‚
**å¯¹äºæ–°æ‰‹å’Œè€æ‰‹æ¥è¯´éƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚**
### pipenv éƒ½åŒ…å«ä»€ä¹ˆï¼Ÿ
pipenv æ˜¯ Pipfile ä¸»è¦å€¡å¯¼è€…ã€requests ä½œè€… Kenneth Reitz
å†™çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»è¦åŒ…å«äº†Pipfileã€pipã€clickã€requestså’Œvirtualenvã€‚Pipfileå’Œpipenvæœ¬æ¥éƒ½æ˜¯Kenneth
Reitzçš„ä¸ªäººé¡¹ç›®ï¼Œåæ¥è´¡çŒ®ç»™äº†pypaç»„ç»‡ã€‚Pipfileæ˜¯ç¤¾åŒºæ‹Ÿå®šçš„ä¾èµ–ç®¡ç†æ–‡ä»¶ï¼Œç”¨äºæ›¿ä»£è¿‡äºç®€é™‹çš„ requirements.txt æ–‡ä»¶ã€‚
Pipfileçš„åŸºæœ¬ç†å¿µæ˜¯ï¼š
  1. Pipfile æ–‡ä»¶æ˜¯ TOML æ ¼å¼è€Œä¸æ˜¯ requirements.txt è¿™æ ·çš„çº¯æ–‡æœ¬ã€‚
  2. ä¸€ä¸ªé¡¹ç›®å¯¹åº”ä¸€ä¸ª Pipfileï¼Œæ”¯æŒå¼€å‘ç¯å¢ƒä¸æ­£å¼ç¯å¢ƒåŒºåˆ†ã€‚é»˜è®¤æä¾› default å’Œ development åŒºåˆ†ã€‚
  3. æä¾›ç‰ˆæœ¬é”æ”¯æŒï¼Œå­˜ä¸º Pipfile.lockã€‚
clickæ˜¯Flaskä½œè€… Armin Ronacher å†™çš„å‘½ä»¤è¡Œåº“ï¼Œç°åœ¨Flaskå·²ç»é›†æˆäº†å®ƒã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆä½¿ç”¨å®ƒå§
### å…¥é—¨
pipenvå…¼å®¹Python 2/3ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥Macä¸‹Python 3ä¸ºä¾‹ï¼š
#### å®‰è£…pipenv

``` python    
    
    â¯ brew install python3  # å¦‚æœå·²ç»å®‰è£…äº†å¯ä»¥å¿½ç•¥  
    â¯ python3 -m pip install --upgrade --force-reinstall pip  
    â¯ pip3 install pipenv --user  # æ¨èå®‰è£…åœ¨ä¸ªäººç›®å½•ä¸‹  
    â¯ export PATH="/Users/dongweiming/Library/Python/3.6/bin:$PATH"  # æŠŠç”¨æˆ·ç›®å½•ä¸‹binæ”¾åœ¨æœ€å‰é¢ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥ä½¿ç”¨pipenväº†  
      
```
  
#### ä½¿ç”¨pipenv
ç”¨ä¸€ä¸ªç©ºç›®å½•ä½“éªŒä¸€ä¸‹ï¼š

``` python    
    
    â¯ mkdir test_pipenv  
    â¯ cd test_pipenv  
    â¯ pipenv install  # åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ  
    Creating a virtualenv for this projectâ€¦  
    ...  
    Installing setuptools, pip, wheel...done.  
      
    Virtualenv location: /Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5  
    Creating a Pipfile for this projectâ€¦  
    Pipfile.lock not found, creatingâ€¦  
    Locking [dev-packages] dependenciesâ€¦  
    Locking [packages] dependenciesâ€¦  
    Updated Pipfile.lock (c23e27)!  
    Installing dependencies from Pipfile.lock (c23e27)â€¦  
      ğŸ   â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 0/0 â€” 00:00:00  
    To activate this project's virtualenv, run the following:  
     $ pipenv shell  
      
    â¯ which python3  
    /usr/local/Cellar/python3/3.6.1/bin/python3  # è¿˜æ˜¯macè‡ªå¸¦çš„Python  
      
    â¯ pipenv shell  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ  
    Spawning environment shell (/bin/zsh). Use 'exit' to leave.  
    source /Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5/bin/activate  
      
    â¯ which python3  # å·²ç»åœ¨è™šæ‹Ÿç¯å¢ƒé‡Œäº†  
    /Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5/bin/python3  
      
    â¯ exit  # é€€å‡ºè™šæ‹Ÿç¯å¢ƒ  
      
    â¯ which python3  
    /usr/local/Cellar/python3/3.6.1/bin/python3  
      
```
  
ä»¥ä¸Šå°±æ˜¯åŸæ¥virtualenvçš„åŸºæœ¬ç”¨æ³•äº†ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å½“å‰ç›®å½•ç°åœ¨æ˜¯ä»€ä¹ˆæ ·å­çš„:

``` python    
    
    â¯ ls  
    Pipfile  Pipfile.lock  
      
```
  
è¿™ä¸ªç¯å¢ƒä¸‹ç›®å‰ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚æˆ‘ä»¬å®‰è£…2ä¸ªåŒ…ï¼š

``` python    
    
    â¯ pipenv install elasticsearch-dsl requests  
    Installing elasticsearch-dslâ€¦  
    ...  
    Adding elasticsearch-dsl to Pipfile's [packages]â€¦  
    Installing requestsâ€¦  
    ...  
    Adding requests to Pipfile's [packages]â€¦  
      PS: You have excellent taste! âœ¨ ğŸ° âœ¨  
    Locking [dev-packages] dependenciesâ€¦  
    Locking [packages] dependenciesâ€¦  
    Updated Pipfile.lock (8d307d)!  
      
```
  
ç°åœ¨Pipfile.lockå·²ç»æ›´æ–°äº†ï¼ŒåŒ…å«äº† elasticsearch-dslã€requests å’Œç›¸å…³ä¾èµ–çš„åŒ…ä¿¡æ¯ã€‚
å¦å¤–å¦‚æœä½ æ·»åŠ â€“twoæˆ–â€“threeæ ‡å¿—åˆ°ä¸Šé¢çš„æœ€åä¸€ä¸ªå‘½ä»¤ï¼Œå®ƒåˆ†åˆ«ä½¿ç”¨Python 2æˆ–3æ¥åˆå§‹åŒ–ä½ çš„é¡¹ç›®ã€‚ å¦åˆ™å°†ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬çš„Pythonã€‚
å¯ä»¥çœ‹ä¸€ä¸‹ä¾èµ–å…³ç³»ï¼š

``` python    
    
    â¯ pipenv graph  
    elasticsearch-dsl==6.1.0  
      - elasticsearch [required: <7.0.0,>=6.0.0, installed: 6.1.1]  
        - urllib3 [required: <1.23,>=1.21.1, installed: 1.22]  
      - ipaddress [required: Any, installed: 1.0.19]  
      - python-dateutil [required: Any, installed: 2.6.1]  
        - six [required: >=1.5, installed: 1.10.0]  
      - six [required: Any, installed: 1.10.0]  
    requests==2.18.4  
      - certifi [required: >=2017.4.17, installed: 2017.11.5]  
      - chardet [required: <3.1.0,>=3.0.2, installed: 3.0.4]  
      - idna [required: <2.7,>=2.5, installed: 2.6]  
      - urllib3 [required: <1.23,>=1.21.1, installed: 1.22]  
      
```
  
å¯ä»¥çœ‹åˆ°ï¼Œä»–ä¿©éƒ½ä¾èµ–äº†urllib3ã€‚è™½ç„¶ç°åœ¨pipenvä¸èƒ½ç›´æ¥å¸è½½åŒ…åŠå…¶ä¾èµ–ï¼Œä½†æ˜¯ç”±äºå®ƒæä¾›äº†è‰¯å¥½çš„æ¥å£ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å®ç°ï¼š

``` python    
    
    â¯ pipenv uninstall `pipenv graph --json |python3 depends.py requests`  
    Un-installing certifiâ€¦  
    Uninstalling certifi-2017.11.5:  
      Successfully uninstalled certifi-2017.11.5  
      
    No package certifi to remove from Pipfile.  
    Un-installing requestsâ€¦  
    Uninstalling requests-2.18.4:  
      Successfully uninstalled requests-2.18.4  
      
    Removing requests from Pipfileâ€¦  
    Un-installing idnaâ€¦  
    Uninstalling idna-2.6:  
      Successfully uninstalled idna-2.6  
      
    No package idna to remove from Pipfile.  
    Un-installing chardetâ€¦  
    Uninstalling chardet-3.0.4:  
      Successfully uninstalled chardet-3.0.4  
      
    No package chardet to remove from Pipfile.  
    Locking [dev-packages] dependenciesâ€¦  
    Locking [packages] dependenciesâ€¦  
    Updated Pipfile.lock (c05ac4)!  
      
```
  
å…¶ä¸­depends.pyè„šæœ¬ä¼šè§£æä¾èµ–å…³ç³»ï¼Œæ’é™¤å…¶ä»–åŒ…ä¾èµ–çš„é¡¹ç›®ç„¶ååˆ é™¤ï¼š

``` python    
    
    â¯ cat depends.py  
    import sys  
    import json  
      
    package = sys.argv[1]  
    other_dependencies = set()  
    removing_dependencies = set([package])  
      
    for i in json.load(sys.stdin):  
        for p in i['dependencies']:  
            key = p['key']  
            if i['package']['key'] == package:  
                removing_dependencies.add(key)  
            else:  
                other_dependencies.add(key)  
      
    print(' '.join(removing_dependencies - other_dependencies))  
      
```
  
å†çœ‹ä¸€ä¸‹ç°åœ¨ç¯å¢ƒä¸­çš„åŒ…ä¾èµ–å…³ç³»ï¼š

``` python    
    
    â¯ pipenv graph  
    elasticsearch-dsl==6.1.0  
      - elasticsearch [required: >=6.0.0,<7.0.0, installed: 6.1.1]  
        - urllib3 [required: >=1.21.1,<1.23, installed: 1.22]  
      - ipaddress [required: Any, installed: 1.0.19]  
      - python-dateutil [required: Any, installed: 2.6.1]  
        - six [required: >=1.5, installed: 1.10.0]  
      - six [required: Any, installed: 1.10.0]  
      
```
  
æ˜¯ä¸æ˜¯å¾ˆå¹²å‡€å‘¢ï¼Ÿ
#### å…¶ä»–åŠŸèƒ½
é™¤äº†ä¸Šè¿°åŸºæœ¬åŠŸèƒ½ä»¥å¤–ï¼Œpipenvè¿˜æœ‰å¾ˆå¤šé™„åŠ çš„åŠŸèƒ½ï¼Œæˆ‘ä¸¾å‡ ä¸ªæ—¥å¸¸æ¯”è¾ƒå¸¸ç”¨çš„ä¾‹å­ï¼š

``` python    
    
    â¯ pipenv run which python # ã€Œpipenv runã€å¯ä»¥æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶ä½¿ç”¨shellå‘½ä»¤  
    /Users/dongweiming/.virtualenvs/test_pipenv-GP_s2TW5/bin/python  
    â¯ pipenv check  # æ£€æŸ¥è£…çš„åŒ…çš„å®‰å…¨æ€§  
    Checking PEP 508 requirementsâ€¦  
    Passed!  
    Checking installed package safetyâ€¦  
    All good!  
    â¯ pipenv --man  # ä¼ ç»Ÿçš„çœ‹æ–‡æ¡£çš„æ–¹æ³•  
    â¯ pipenv check --style depends.py  # ä»£ç Flake8æ£€æŸ¥ï¼Œåœ¨è¿™é‡Œæˆ‘ä¿®æ”¹äº†depends.pyè®©å®ƒæ•…æ„æœ‰é—®é¢˜  
    /Users/dongweiming/test_pipenv/depends.py:1:1: F401 'os' imported but unused  
      
```
  
å¦å¤–ç”±äºautoenvä¹Ÿæ˜¯Kenneth Reitzå†™çš„ï¼Œæ‰€ä»¥pipenvé»˜è®¤ä¹ŸåŒ…å«äº†å¯¹.envæ–‡ä»¶çš„æ”¯æŒã€‚
æ˜¯ä¸æ˜¯æ–¹ä¾¿å¾ˆå¤šå‘¢ï¼Ÿ

ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ç”± è‘£ä¼Ÿæ˜ åŸåˆ›ï¼Œæœªç»ä½œè€…æˆæƒç¦æ­¢ä»»ä½•å¾®ä¿¡å…¬ä¼—å·å’Œå‘æ˜é‡‘(juejin.im)è½¬è½½ï¼Œ[æŠ€æœ¯åšå®¢è½¬è½½é‡‡ç”¨ ä¿ç•™ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0-å›½é™…è®¸å¯åè®®](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh)
python
