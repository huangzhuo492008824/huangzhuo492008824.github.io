
---
date: 2016-03-17 18:30:58
categories: python
title: çŸ¥ä¹Liveå…¨æ–‡æœç´¢ä¹‹ä½¿ç”¨Elasticsearchåšèšåˆåˆ†æ
tags: [python]
---
ESé™¤äº†å…¨æ–‡æœç´¢ä»¥å¤–è¿˜æœ‰ä¸€ä¸ªä¸»è¦åŠŸèƒ½, å°±æ˜¯æ•°æ®çš„èšåˆåˆ†æã€‚æˆ‘ä¼šåœ¨å¾®ä¿¡å°ç¨‹åºé‡Œç”¨åˆ°èšåˆåŠŸèƒ½ã€‚ä»Šå¤©å…ˆä»‹ç»ä¸€ä¸‹ã€‚
ç›®å‰DSLåº“æ”¯æŒå¦‚ä¸‹ä¸‰ç§å¸¸ç”¨èšåˆæ¨¡å¼
### Metrics Aggregations
é¡¾åæ€ä¹‰, ä¸»è¦æ˜¯ç”¨äºè®¡ç®—ç‰¹å®šçš„åº¦é‡å­—æ®µï¼ŒMetricå¾ˆåƒSQLä¸­çš„avgã€maxã€minç­‰æ–¹æ³•ã€‚æˆ‘ä»¬æ‰¾ä¸€ä¸‹æœ€å¤šçš„Liveæœ‰å¤šå°‘äººæ„Ÿå…´è¶£ï¼š

``` python    
    
    In : from elasticsearch_dsl import A  
    In : s = Live.search()  
    In : s.aggs.metric('max_liked_num', A('max', field='liked_num'))  
    Out: <elasticsearch_dsl.search.Search at 0x10a47b550>  
      
    In : r = s.execute()  
    In : r.aggregations.max_liked_num  
    Out: {'value': 6918.0}  
      
```
  
åš¯ã€‚çœ‹çœ‹æ˜¯å“ªä¸€ä¸ªå§ï¼š

``` python    
    
    In [27]: s.query('match', liked_num=6918).execute()[0].subject  
    Out[27]: 'è‡´æ‰€æœ‰è¿‘è§†æƒ³æ‘˜æ‰çœ¼é•œçš„ä½ ä»¬'  
      
```
  
æœ‰ç‚¹å‡ºäººæ„æ–™å“¦~
å…¶å®åº¦é‡çš„ä¹Ÿä¸ä¸€å®šæ˜¯æ–‡æ¡£çš„æŸä¸ªç‰¹å®šå­—æ®µå€¼, å¯ä»¥æ˜¯æ–‡æ¡£é€šè¿‡è„šæœ¬ç”Ÿæˆçš„å€¼ã€‚æ¯”å¦‚æˆ‘ä»¬çœ‹çœ‹å…¨éƒ¨Liveå¹³å‡æ”¶å…¥ï¼Œæ”¶å…¥=ç¥¨ä»·*å‚ä¸äººæ•°ï¼Œæ˜¯2ä¸ªå­—æ®µã€‚è¦è¿™æ ·ç”¨ï¼š

``` python    
    
    In : from elasticsearch_dsl import A  
      
    In : s = Live.search()  
    In : s.aggs.metric('avg_income', A('scripted_metric', init_script="params._agg['incomes'] = []", map_script="params._agg.incomes.add(doc.amou  
    ...: nt.value * doc.seats_taken.value)", combine_script='double total=0; int num_of_income=0; for (i in params._agg.incomes) { total += i; nu  
    ...: m_of_income += 1 } return [total, num_of_income]', reduce_script='double total=0; int num_of_income=0; for (item in params._aggs) { tota  
    ...: l += item[0]; num_of_income += item[1]} return total / num_of_income'))  
    Out: <elasticsearch_dsl.search.Search at 0x10a512898>  
      
    In : rs = s.execute()  
      
    In : rs.aggregations.avg_income  
    Out: {'value': 32934.61029513591}  
      
```
  
æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬æŠŠscripted_metricçš„å‚æ•°åˆ†å¼€è¯´ï¼š
  1. init_scriptã€‚ åˆå§‹åŒ–æ—¶è¿è¡Œï¼Œä¸€èˆ¬æ˜¯è®¾ç½®åˆå§‹çš„å…¨å±€å˜é‡
  2. map_scriptã€‚ä¼šå¯¹æ¯ä¸ªæ–‡æ¡£åšå¾ªç¯ï¼ŒæŠŠæ¯ä¸ªè®¡ç®—å¥½çš„æ”¶å…¥ç”¨addæ–¹æ³•åŠ åˆ°æ¯ä¸ªåˆ†ç‰‡çš„params._agg.incomesé‡Œé¢ã€‚
  3. combine_scriptã€‚æˆ‘ä»¬çŸ¥é“ESæ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ•°æ®æœ‰å¤šä¸ªåˆ†ç‰‡ï¼Œå½“map_scriptå®Œæˆåï¼Œå®ƒç”¨æ¥å¯¹æ¯ä¸ªåˆ†ç‰‡çš„é‚£éƒ¨åˆ†ç»“æœåšæ±‚å’Œå’Œè®¡æ•°çš„é¢„å¤„ç†
  4. reduce_scriptã€‚å¦‚æœä½ äº†è§£MapReduceï¼Œæˆ‘æƒ³å¯¹2å’Œ4æ­¥å°±èƒ½æ›´å¥½çš„ç†è§£äº†ï¼Œè¿™ä¸€æ­¥èƒ½é€šè¿‡params._aggsæŠŠæ¯ä¸ªåˆ†ç‰‡çš„é¢„å¤„ç†ç»“æœæ‹¿æ¥å†åšå¤„ç†ï¼Œæœ€åé€šè¿‡æ€»æ”¶å…¥å’Œliveæ•°æ±‚å¾—å¹³å‡å€¼ã€‚
å¾ˆåº†å¹¸æ²¡æœ‰ç»™å¹³å‡å€¼æ‹–åè…¿ã€‚BTWï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç»§ç»­æŒ–æ˜ä¸ºå•¥å¹³å‡æ”¶å…¥è¿™ä¹ˆé«˜ã€‚è€Œä¸”æ³¨æ„é¢ï¼Œæˆ‘è€ƒè™‘çš„åªæ˜¯æ™®é€šç¥¨ä»·ï¼Œæ²¡æœ‰ç®—é‚£äº›ã€ŒèŠè¡¨å¿ƒæ„ã€ã€ã€Œé¼åŠ›æ”¯æŒã€çš„ç¥¨ï¼Œè¿™ä¼šè®©å¹³å‡å€¼æ›´é«˜ä¸€äº›ã€‚
ä¸Šé¢çš„ä¾‹å­ä¹Ÿçš„å¥½é•¿å•Šã€‚æˆ‘ä¸å¤ªæ»¡æ„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥ç®€åŒ–ä¸€ä¸‹å‘¢? ä¹Ÿå°±æ˜¯combine_scriptä¸é¢„è®¡ç®—ï¼Œç»Ÿä¸€åœ¨reduce_scriptè®¡ç®—ï¼š

``` python    
    
    In : s = Live.search()  
    In : s.aggs.metric('avg_income', A('scripted_metric', init_script="params._agg['incomes'] = []", map_script="params._agg.incomes.add(doc.amou  
    ...: nt.value * doc.seats_taken.value)", combine_script='return params._agg.incomes', reduce_script='double total=0; int num_of_income=0; for  
    ...:  (shard in params._aggs) { for (income in shard) {total += income; num_of_income += 1}} return total / num_of_income'))  
    Out: <elasticsearch_dsl.search.Search at 0x10a53a470>  
      
    In : r = s.execute()  
    In : r.aggregations.avg_income  
    Out: {'value': 32934.61029513591}  
      
```
  
åªæ˜¯åœ¨combine_scriptç”¨äº†ä¸ªåµŒå¥—å¾ªç¯ã€‚
### Bucket Aggregations
Bucketåœ¨è‹±è¯­é‡Œé¢æœ‰ã€Œæ¡¶ã€çš„æ„æ€ï¼ŒBucket Aggregationsä¼šæŠŠç¬¦åˆæŸç§æ¡ä»¶çš„æ–‡æ¡£ä¸¢è¿›ä¸€ä¸ªBucketï¼Œè€Œä¸”è¿˜å¯ä»¥å®ç°å­èšåˆï¼ˆsub-
aggregationsï¼‰ã€‚
Elasticsearchæ˜¯åŸºäºLuceneæ„å»ºçš„ã€‚å¦‚æœä½ äº†è§£è¿‡Luceneï¼Œç›¸ä¿¡çŸ¥é“docValueï¼Œå®ƒèŠ‚çœå†…å­˜ã€åšæ’åºï¼Œåˆ†ç»„ç­‰èšåˆæ“ä½œæ—¶èƒ½å¤Ÿå¤§å¤§æå‡æ€§èƒ½ã€‚æˆ‘ä»¬ä¹‹å‰çš„modelé‡Œé¢å¤§å¤šä½¿ç”¨äº†æ–‡æœ¬å­—æ®µï¼ˆTextï¼‰ï¼Œè¿™æ˜¯ç”¨ä½œè¿›è¡Œå…¨æ–‡æœç´¢çš„ï¼Œè€Œå¸Œæœ›åšèšåˆè®¡ç®—ï¼Œéœ€è¦ä½¿ç”¨Keywordç±»å‹çš„å­—æ®µã€‚æ‰€ä»¥æˆ‘æ·»åŠ äº†ä¸€ä¸ªtopicså­—æ®µï¼š

``` python    
    
    from elasticsearch_dsl import Keyword, DocType  
      
    class Live(DocType):  
        ...  
        topic_names = Text(analyzer='ik_max_word')  
        topics = Keyword()  # æ–°å¢  
      
```
  
å…¶å®DSLè¿˜æ”¯æŒä¸€ç§ç”¨å­å­—æ®µçš„å†™æ³•ï¼š

``` python    
    
    topic_names = Text(analyzer='ik_max_word', fields={'raw': Keyword()})  
      
```
  
ç”±äºæ‹…å¿ƒæœªæ¥Liveçš„Topicä¼šæœ‰å¤šä¸ªï¼Œæ‰€ä»¥topic_namesæ˜¯ä¸€ä¸ªç”¨joinæŠŠtopicåˆ—è¡¨ä¸²èµ·æ¥çš„å­—ç¬¦ä¸²ï¼Œè€Œéœ€æ±‚ä¸Štopicsæ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªtopicçš„åˆ—è¡¨ï¼Œè¿˜æ˜¯é¢å¤–æ–°åŠ ä¸€ä¸ªå­—æ®µå§ã€‚
è¿™æ ·é‡æ–°è·‘çˆ¬è™«ï¼Œè¡¥å……ä¸‹topicså­—æ®µä¹‹åï¼ŒæŒ‰toicsç¬¦åˆæ•°é‡æ’åºï¼Œçœ‹çœ‹liveä¸­é‚£äº›ç±»å‹çš„Liveæ›´å¤šï¼š

``` python    
    
    In : s = Live.search()  
    In : s.aggs.bucket('categories', A('terms', field='topics'))  
    Out: <elasticsearch_dsl.search.Search at 0x10a532d30>  
      
    In : r = s.execute()  
      
    In : r.aggregations.categories.buckets  
    Out:  
    [{'key': 'ç”Ÿæ´»æ–¹å¼', 'doc_count': 145},  
     {'key': 'é‡‘è', 'doc_count': 94},  
     {'key': 'éŸ³ä¹', 'doc_count': 87},  
     {'key': 'è‰ºæœ¯', 'doc_count': 73},  
     {'key': 'æ•™è‚²', 'doc_count': 59},  
     {'key': 'ç§‘æŠ€', 'doc_count': 59},  
     {'key': 'å¿ƒç†å­¦', 'doc_count': 56},  
     {'key': 'èŒä¸š', 'doc_count': 56},  
     {'key': 'äº’è”ç½‘', 'doc_count': 48},  
     {'key': 'åŒ»å­¦', 'doc_count': 42}]  
      
```
  
çœ‹åˆ°äº†å§ï¼Œå½°æ˜¾é€¼æ ¼çš„ã€Œç”Ÿæ´»æ–¹å¼ã€è¯é¢˜çš„Liveæœ€å¤šï¼Œè±¡å¾æ›´å¤šé’±çš„é‡‘èè¯é¢˜æ¬¡ä¹‹â€¦
ç°åœ¨æ˜¯ä¸æ˜¯æœ‰ç§ç†Ÿæ‚‰çš„æ„Ÿè§‰ï¼šèšåˆçŸ­è¯­termsè¿™ä¸æ˜¯SQLé‡Œé¢çš„group byå˜›ï¼Ÿ
PS: å¦‚æœè¦ä½¿ç»“æœè¿”å›æ‰€æœ‰èšåˆç»“æœçš„è¯, éœ€è¦åŠ ä¸Šsizeå‚æ•°:

``` python    
    
    s.aggs.bucket('categories', A('terms', field='topics', size=20))  
      
```
  
PS: ä»ES5.0å¼€å§‹ï¼Œsizeä¸å†èƒ½æŒ‡å®š0è€Œè¿”å›å…¨éƒ¨ç»“æœäº†ï¼Œéœ€è¦æ˜ç¡®æŒ‡å®šä¸€ä¸ªå¤§äº0çš„æ•´æ•°ã€‚
Bucketèšåˆæ”¯æŒå¤šç§ç±»å‹ï¼Œæˆ‘ä»¬å†æ¼”ç¤ºä¸‹èŒƒå›´èšåˆã€‚ ç°åœ¨æŠŠç¥¨ä»·åˆ†æˆä¸‰ä¸ªèŒƒå›´ï¼š
  1. å°äº20çš„
  2. 20-100ä¹‹é—´çš„
  3. å¤§äº100çš„
è¿™æ ·å†™ï¼š

``` python    
    
    In : s = Live.search()  
    In : s.aggs.bucket('amount_eq_100', A('range', field='amount', ranges=[{'from': 100}, {'from': 20, 'to': 100}, {'to': 20}]))  
    Out: Range(field='amount', ranges=[{'from': 100}, {'from': 20, 'to': 100}, {'to': 20}])  
      
    In : r = s.execute()  
    In : buckets = r.aggregations.amount_eq_100.buckets  
    In : for bucket in buckets:  
    ...:     print('{}: {}'.format(bucket['key'], bucket['doc_count']))  
    ...:  
    *-20.0: 1159  
    20.0-100.0: 683  
    100.0-*: 20  
      
```
  
æœ€åæ¼”ç¤ºä¸‹date_histogramå‹çš„èšåˆï¼Œhistogramé¡¾åæ€ä¹‰æ˜¯ç›´æ–¹å›¾çš„æ„æ€ï¼Œæˆ‘ä»¬çœ‹çœ‹ä»Liveè¯ç”Ÿåˆ°ç°åœ¨ï¼Œæ¯ä¸ªæœˆï¼ˆå³å°†ï¼‰ä¸¾è¡ŒLiveçš„æ•°é‡åˆ†åˆ«æ˜¯å¤šå°‘ï¼š

``` python    
    
    In : s = Live.search()  
    In : s.aggs.buckets('start_at', A('date_histogram', field='starts_at', interval='month'))  
    Out: <elasticsearch_dsl.search.Search at 0x10a6ea3c8>  
      
    In : r = s.execute()  
    In : r.aggregations.start_at.buckets  
    Out:  
    [{'key_as_string': '2016-05-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-06-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-07-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-08-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-09-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-10-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-11-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-12-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-01-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-02-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-03-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-04-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-05-01T00:00:00.000Z', 'key': datetim...}]  
      
    In : q = r.aggregations.start_at.buckets[0]  
    In : q.doc_count  
    Out: 20  
    In : q.key  
    Out: datetime.datetime(2016, 5, 1, 0, 0)  
      
```
  
intervalæ”¯æŒå¤šç§ç±»å‹ï¼šå¦‚year, quarter, month, week, day, hour, minute, secondç­‰ã€‚
### Pipeline Aggregations
ç®¡é“èšåˆæ˜¯åœ¨Elasticsearch 2.xæ–°å¢çš„ä¸€ç§èšåˆç±»å‹ï¼Œå¯ä»¥åœ¨ç°æœ‰çš„èšåˆæ•°æ®ä¹‹ä¸Šï¼Œå†å¯¹å…¶åšä¸€æ¬¡è¿ç®—ã€‚è¿™ç±»ä¼¼SQLçš„Subqueryã€‚
Pipelineåˆ†ä¸º2ç±»ï¼š
  1. parentã€‚èšåˆçš„è¾“å…¥æ˜¯éPipelineèšåˆçš„è¾“å‡ºï¼Œå¹¶å¯¹å…¶è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚ä¸€èˆ¬ä¸ç”Ÿæˆæ–°çš„æ¡¶ï¼Œè€Œæ˜¯å¯¹çˆ¶èšåˆæ¡¶ä¿¡æ¯çš„replaceã€‚
  2. siblingã€‚èšåˆçš„è¾“å…¥æ˜¯å…¶ä»–Pipelineèšåˆçš„è¾“å‡ºã€‚å¹¶èƒ½åœ¨åŒçº§ä¸Šè®¡ç®—æ–°çš„èšåˆã€‚
ç®¡é“èšåˆé€šè¿‡buckets_pathå‚æ•°æŒ‡å®šä»–ä»¬è¦è¿›è¡Œèšåˆè®¡ç®—çš„æƒå€¼å¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

``` python    
    
    AGG_SEPARATOR       =  '>' ;  æŒ‡å®šçˆ¶å­èšåˆå…³ç³»  
    METRIC_SEPARATOR    =  '.' ;  æŒ‡å®šèšåˆçš„ç‰¹å®šæƒå€¼  
    AGG_NAME            =  <the name of the aggregation> ;  ç›´æ¥æŒ‡å®šèšåˆçš„åç§°  
    METRIC              =  <the name of the metric (in case of multi-value metrics aggregation)> ;  ç›´æ¥æŒ‡å®šæƒå€¼  
    PATH                =  <AGG_NAME> [ <AGG_SEPARATOR>, <AGG_NAME> ]* [ <METRIC_SEPARATOR>, <METRIC> ] ; ç»¼åˆä¸Šé¢çš„æ–¹å¼æŒ‡å®šå®Œæ•´è·¯å¾„  
      
```
  
çœ‹2ä¸ªä¾‹å­å°±å¥½æ‡‚äº†ã€‚é¦–å…ˆæ¼”ç¤ºsiblingç±»å‹çš„ï¼ŒåŸºäºä¸ŠèŠ‚date_histogramèšåˆä¾‹å­äº†ï¼Œæˆ‘ä»¬ç®—ä¸€ä¸‹æ¯ä¸ªæœˆçš„Liveæ€»æ”¶å…¥

``` python    
    
    In : agg = A('date_histogram', field='starts_at', interval='month')  
    In : agg.bucket('incomes', A('sum', script={'inline': "doc['seats_taken'].value* doc['amount'].value"}))  
    Out: Sum(script={'inline': "doc['seats_taken'].value* doc['amount'].value"})  
    In : s.aggs.bucket('incomes_per_month', agg)  
    Out: DateHistogram(aggs={'incomes': Sum(script={'inline': "doc['seats_taken'].value* doc['amount'].value"})}, field='starts_at', interval='month')  
      
```
  
ä¸ºäº†æ„é€ æ›´å¥½ç†è§£çš„èšåˆè¯­å¥ï¼Œå…ˆç”Ÿæˆä¸€ä¸ªaggå˜é‡ï¼Œå¯ä»¥çœ‹åˆ°Bucketså’ŒMetricså¯ä»¥ç”¨å‡½æ•°å¼çš„æ–¹å¼ç”¨å¤šä¸ªï¼Œä¹Ÿè¦æ³¨æ„å½“éœ€æ±‚å¤æ‚çš„æ—¶å€™éƒ½æ˜¯å¯ä»¥é€šè¿‡scriptæ¥å®ç°çš„ã€‚æ¥ç€åŠ å…¥2ä¸ªç®¡é“ï¼Œå†åˆ†åˆ«è·å¾—æœ€å¤§æœˆæ”¶å…¥å’Œå…¨éƒ¨æœˆæ”¶å…¥ï¼š

``` python    
    
    In : s.aggs.pipeline('max_monthly_incomes', agg_type='max_bucket', buckets_path='incomes_per_month>incomes')  
    Out: <elasticsearch_dsl.search.Search at 0x10a75b518>  
    In : s.aggs.pipeline('sum_monthly_incomes', agg_type='sum_bucket', buckets_path='incomes_per_month>incomes')  # æ³¨æ„agg_typeä¸ä¸€æ ·  
    Out: <elasticsearch_dsl.search.Search at 0x10a75b518>  
      
    In : r = s.execute()  
    In : r.aggregations.incomes_per_month.buckets  
    Out:  
    [{'key_as_string': '2016-05-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-06-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-07-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-08-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-09-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-10-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-11-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2016-12-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-01-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-02-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-03-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-04-01T00:00:00.000Z', 'key': datetim...},  
     {'key_as_string': '2017-05-01T00:00:00.000Z', 'key': datetim...}]  
      
    In : a = r.aggregations.incomes_per_month.buckets[0]  
    In : a.doc_count  
    Out: 20  
    In : a.incomes  
    Out: {'value': 210088.48763275146}  
      
    In : r.aggregations.max_monthly_incomes  
    Out: {'value': 18330342.949926138, 'keys': ['2016-10-01T00:00:00....}  # åæœˆä»½æ”¶å…¥æœ€å¤š  
      
    In : r.aggregations.sum_monthly_incomes  
    Out: {'value': 61324244.369543076}  # æ»¡çœ¼çš„é’±ï¼Œç°é‡‘ğŸ‚å•Š  
      
```
  
æ•°å®Œäº†é’±ï¼Œæ€è€ƒä¸‹ã€‚è¿™ä¸ªä¾‹å­å°±æ˜¯siblingèšåˆï¼Œå› ä¸ºsum_monthly_incomesã€max_monthly_incomeså’Œincomes_per_monthåœ¨ä¸€ä¸ªåŒºé—´å†…çš„ï¼ˆéƒ½æ˜¯aggsçš„é”®ï¼‰ã€‚
æˆ‘ä¹‹å‰æˆ‘ä»¬ç®—è¿‡ä¹ˆæ¯ä¸ªæœˆLiveçš„æ€»æ”¶å…¥ï¼Œå…¨éƒ¨Liveçš„å¹³å‡æ”¶å…¥ã€‚æˆ‘ä»¬ç°åœ¨ç®—ä¸€ä¸‹æ¯ä¸ªæœˆLiveçš„å¹³å‡æ”¶å…¥ï¼š

``` python    
    
    In : agg = A('date_histogram', field='starts_at', interval='month')  
    In : agg.bucket('total_incomes', A('sum', script={'inline': "doc['seats_taken'].value* doc['amount'].value"}))  
    Out: Sum(script={'inline': "doc['seats_taken'].value* doc['amount'].value"})  
      
    In : agg.pipeline('avg_income', agg_type='bucket_script', buckets_path={'total': 'total_incomes', 'count': '_count'}, script='params.total/params.count')  # _countæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è·¯å¾„ï¼Œè¡¨ç¤ºå½“å‰bucketé‡Œé¢çš„æ–‡æ¡£æ•°é‡  
    Out: DateHistogram(aggs={'total_incomes': Sum(script={'inline': "doc['seats_taken'].value* doc['amount'].value"}), 'avg_income': BucketScript(buckets_path={'total': 'total_incomes', 'count': '_count'}, script='params.total/params.count')}, field='starts_at', interval='month')  
      
    In : s = Live.search()  
    In : s.aggs.bucket('avg_income_per_month', agg)  
    Out: DateHistogram(aggs={'total_incomes': Sum(script={'inline': "doc['seats_taken'].value* doc['amount'].value"}), 'avg_income': BucketScript(buckets_path={'total': 'total_incomes', 'count': '_count'}, script='params.total/params.count')}, field='starts_at', interval='month')  
      
    In : r = s.execute()  
    In : buckets = r.aggregations.avg_income_per_month.buckets  
    In : b = buckets[0]  
      
    In : b.total_incomes  
    Out: {'value': 210088.48763275146}  
    In : b.doc_count  
    Out: 20  
    In : b.avg_income  
    Out: {'value': 10504.424381637573}  
      
```
  
è¿™å°±æ˜¯parentç±»å‹çš„ç®¡é“èšåˆäº†ï¼Œå®ƒå¯¹æ¯ä¸ªæ¡¶è‡ªå·±å»åšè¿ç®—ã€‚
ä»Šå¤©å…ˆåˆ°è¿™é‡Œäº†ï¼Œä¸‹ä¸€ç¯‡å°†åŸºäºè¿™å‡ å¤©å¯¹ESçš„å­¦ä¹ å®ç°ä¸€ä¸ªå¯¹çŸ¥ä¹Liveè¿›è¡Œå…¨æ–‡æœç´¢çš„å¾®ä¿¡å°ç¨‹åºäº†

ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ç”± è‘£ä¼Ÿæ˜ åŸåˆ›ï¼Œæœªç»ä½œè€…æˆæƒç¦æ­¢ä»»ä½•å¾®ä¿¡å…¬ä¼—å·å’Œå‘æ˜é‡‘(juejin.im)è½¬è½½ï¼Œ[æŠ€æœ¯åšå®¢è½¬è½½é‡‡ç”¨ ä¿ç•™ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0-å›½é™…è®¸å¯åè®®](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh)
python
